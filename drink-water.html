<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>喝水追踪 | Hydration Tracker</title>
  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --card: #111827;        /* gray-900 */
      --muted: #94a3b8;       /* slate-400 */
      --text: #e5e7eb;        /* gray-200 */
      --primary: #38bdf8;     /* sky-400 */
      --primary-600: #0284c7; /* sky-600 */
      --success: #22c55e;     /* green-500 */
      --warn: #f59e0b;        /* amber-500 */
      --danger: #ef4444;      /* red-500 */
      --cup-border: #0ea5e9;  /* sky-500 */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 70% -10%, #172554 0%, var(--bg) 40%);
      color: var(--text);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 40px;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
    }

    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border: 1px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .title { font-size: 20px; font-weight: 700; letter-spacing: 0.3px; }
    .subtitle { font-size: 12px; color: var(--muted); }

    .card {
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(17,24,39,0.85);
      backdrop-filter: blur(6px);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    }

    /* Left pane: big cup + small cups */
    .hydration {
      display: grid;
      grid-template-rows: auto auto;
      gap: 16px;
    }

    .big-cup {
      position: relative;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: center;
    }

    .cup-visual {
      position: relative;
      height: 320px;
      border: 3px solid var(--cup-border);
      border-bottom-width: 12px;
      border-radius: 0 0 24px 24px;
      overflow: hidden;
      background:
        radial-gradient(120px 40px at 50% -16px, rgba(56,189,248,0.25), rgba(56,189,248,0.0) 70%),
        linear-gradient(180deg, rgba(2,132,199,0.05), rgba(2,132,199,0.0));
    }

    .cup-fill {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 0%;
      background: linear-gradient(180deg, rgba(56,189,248,0.95), rgba(2,132,199,0.95));
      transition: height 500ms ease, box-shadow 500ms ease;
      box-shadow: inset 0 8px 20px rgba(255,255,255,0.25);
    }

    .cup-waves::before, .cup-waves::after {
      content: "";
      position: absolute; left: -25%; right: -25%; height: 30px; top: -15px;
      background-repeat: repeat-x;
      opacity: 0.6;
      animation: drift 6s linear infinite;
      border-radius: 50%;
      background: radial-gradient(24px 14px at 50% 50%, rgba(255,255,255,0.45) 35%, rgba(255,255,255,0) 70%);
      filter: blur(0.2px);
    }
    .cup-waves::after { top: -8px; opacity: 0.35; animation-duration: 9s; }
    @keyframes drift { from{ transform: translateX(0);} to{ transform: translateX(50%);} }

    .metrics {
      display: grid;
      gap: 8px;
    }
    .progress {
      font-size: 32px; font-weight: 800; letter-spacing: 0.3px;
    }
    .progress small { font-weight: 600; color: var(--muted); font-size: 14px; }
    .bar {
      position: relative; height: 10px; border-radius: 999px; background: #111827;
      border: 1px solid rgba(255,255,255,0.06);
      overflow: hidden;
    }
    .bar > span {
      position: absolute; left: 0; top: 0; bottom: 0; width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--primary-600));
      transition: width 400ms ease;
    }

    .badges { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge { font-size: 12px; color: var(--text); border: 1px solid rgba(255,255,255,0.08); padding: 6px 10px; border-radius: 999px; background: rgba(2,132,199,0.08); }

    .small-cups {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
    }
    .sCup {
      cursor: pointer;
      user-select: none;
      padding: 10px 10px 12px;
      text-align: center;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.07);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      transition: transform 120ms ease, background 200ms ease, border-color 200ms ease;
    }
    .sCup:hover { transform: translateY(-2px); }
    .sCup[data-filled="true"] { border-color: rgba(56,189,248,0.8); background: rgba(2,132,199,0.12); }

    .sCup-visual {
      margin: 4px auto 8px;
      width: 42px; height: 56px; border: 2px solid var(--cup-border); border-bottom-width: 6px; border-radius: 0 0 12px 12px; position: relative; overflow: hidden;
    }
    .sCup-fill { position: absolute; left: 0; right: 0; bottom: 0; height: 0%; background: linear-gradient(180deg, rgba(56,189,248,0.9), rgba(2,132,199,0.95)); transition: height 280ms ease; }

    .sCup-vol { font-size: 12px; color: var(--muted); }

    /* Right pane: calendar */
    .calendar {
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 12px;
    }
    .cal-header { display: flex; align-items: center; justify-content: space-between; }
    .cal-header h3 { margin: 0; font-size: 16px; }
    .cal-header .nav { display: flex; gap: 6px; }
    .btn {
      appearance: none; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02);
      color: var(--text); padding: 6px 10px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 12px;
    }
    .btn:hover { background: rgba(255,255,255,0.06); }

    .weekday { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; font-size: 11px; color: var(--muted); }
    .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }

    .day {
      position: relative; height: 90px; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 6px; background: rgba(255,255,255,0.03);
      overflow: hidden;
    }
    .day .date { font-size: 12px; color: var(--muted); }
    .day .amt { position: absolute; left: 6px; bottom: 6px; font-size: 12px; color: var(--text); }
    .day .pctBar { position: absolute; left: 0; right: 0; bottom: 0; height: 0%; background: rgba(56,189,248,0.18); transition: height 250ms ease; }
    .day.today { outline: 1.5px dashed rgba(56,189,248,0.8); outline-offset: -3px; }

    .legend { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
    .legend .swatch { width: 32px; height: 8px; background: linear-gradient(90deg, rgba(56,189,248,0.08), rgba(56,189,248,0.6)); border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); }

    .done {
      display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.35); color: #bbf7d0;
    }

    footer { grid-column: 1 / -1; text-align: center; color: var(--muted); font-size: 12px; opacity: 0.8; }

    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
      .big-cup { grid-template-columns: 1fr; }
      .cup-visual { height: 280px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">喝水追踪</div>
        <div class="subtitle">点击小杯子，填满大杯子。数据保存在浏览器 IndexedDB。</div>
      </div>
      <div class="badges" id="badges"></div>
    </header>

    <section class="card hydration">
      <div class="big-cup">
        <div class="cup-visual" aria-label="大杯子视觉">
          <div class="cup-fill cup-waves" id="cupFill"></div>
        </div>
        <div class="metrics">
          <div class="progress" id="progressText">0 / 0 ml <small>(0%)</small></div>
          <div class="bar"><span id="progressBar"></span></div>
          <div class="badges">
            <span class="badge" id="goalBadge">目标 0 ml</span>
            <span class="badge" id="todayBadge">今天 0 ml</span>
            <span class="badge" id="statusBadge">未达成</span>
          </div>
        </div>
      </div>

      <div class="small-cups" id="smallCups" aria-label="小杯子列表"></div>
    </section>

    <section class="card calendar">
      <div class="cal-header">
        <h3 id="calTitle">日历</h3>
        <div class="nav">
          <button class="btn" id="prevMonth">上月</button>
          <button class="btn" id="thisMonth">本月</button>
          <button class="btn" id="nextMonth">下月</button>
        </div>
      </div>
      <div class="weekday">
        <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
      </div>
      <div class="grid" id="calGrid"></div>
      <div class="legend"><span class="swatch"></span> 颜色高度=达成比例</div>
    </section>

    <footer>提示：在代码顶部修改目标与小杯子数量和容量。</footer>
  </div>

  <script>
    /********************
     * 配置（仅在代码中修改）
     ********************/
    const DAILY_GOAL_ML = 2000; // 今日目标毫升数。示例：2000 ml
    const SMALL_CUPS = [250, 250, 250, 250, 250, 250, 250, 250]; // 小杯容量列表，代表数量与各自毫升数

    /********************
     * 工具函数
     ********************/
    const fmt = (n) => new Intl.NumberFormat('zh-CN').format(Math.round(n));
    // 替换原有 todayKey 与 ymd
    const toLocalYMD = (d = new Date()) => {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    };
    const todayKey = () => toLocalYMD();      // 本地今天
    const ymd = (d) => toLocalYMD(d);         // 日历与查询同样用本地

    /********************
     * IndexedDB 简易封装
     ********************/
    const DB_NAME = 'hydratrack';
    const DB_VER = 1;
    const STORE = 'intake';

    const idb = {
      open() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VER);
          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains(STORE)) {
              const os = db.createObjectStore(STORE, { keyPath: 'date' });
              os.createIndex('by_date', 'date');
            }
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      },
      tx(db, mode='readonly') { return db.transaction(STORE, mode); },
      async get(date) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
          const req = this.tx(db).objectStore(STORE).get(date);
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => reject(req.error);
        });
      },
      async put(record) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
          const req = this.tx(db, 'readwrite').objectStore(STORE).put(record);
          req.onsuccess = () => resolve(true);
          req.onerror = () => reject(req.error);
        });
      },
      async range(start, end) { // inclusive range by date
        const db = await this.open();
        const res = [];
        return new Promise((resolve, reject) => {
          const store = this.tx(db).objectStore(STORE);
          const idx = store.index('by_date');
          const keyRange = IDBKeyRange.bound(start, end);
          const req = idx.openCursor(keyRange);
          req.onsuccess = (e) => {
            const cur = e.target.result;
            if (cur) { res.push(cur.value); cur.continue(); }
            else { resolve(res); }
          };
          req.onerror = () => reject(req.error);
        });
      }
    };

    /********************
     * 状态
     ********************/
    const state = {
      date: todayKey(),
      goal: DAILY_GOAL_ML,
      smalls: SMALL_CUPS.map(v => ({ vol: v, filled: false })),
      total: 0
    };

    /********************
     * 初始化 UI
     ********************/
    const el = {
      cupFill: document.getElementById('cupFill'),
      progressText: document.getElementById('progressText'),
      progressBar: document.getElementById('progressBar'),
      goalBadge: document.getElementById('goalBadge'),
      todayBadge: document.getElementById('todayBadge'),
      statusBadge: document.getElementById('statusBadge'),
      smallCups: document.getElementById('smallCups'),
      badges: document.getElementById('badges'),
      calTitle: document.getElementById('calTitle'),
      calGrid: document.getElementById('calGrid'),
      prevMonth: document.getElementById('prevMonth'),
      nextMonth: document.getElementById('nextMonth'),
      thisMonth: document.getElementById('thisMonth'),
    };

    function renderSmallCups() {
      el.smallCups.innerHTML = '';
      state.smalls.forEach((c, i) => {
        const btn = document.createElement('button');
        btn.className = 'sCup';
        btn.setAttribute('data-idx', i);
        btn.setAttribute('aria-pressed', c.filled ? 'true' : 'false');
        btn.dataset.filled = c.filled ? 'true' : 'false';
        btn.innerHTML = `
          <div class="sCup-visual"><div class="sCup-fill" style="height:${c.filled ? '100%' : '0%'}"></div></div>
          <div class="sCup-vol">${fmt(c.vol)} ml</div>
        `;
        btn.addEventListener('click', onToggleCup);
        el.smallCups.appendChild(btn);
      });
    }

    function updateProgress() {
      const pct = Math.min(100, Math.round((state.total / state.goal) * 100) || 0);
      el.cupFill.style.height = pct + '%';
      el.progressBar.style.width = pct + '%';
      el.progressText.innerHTML = `${fmt(state.total)} / ${fmt(state.goal)} ml <small>(${pct}%)</small>`;
      el.goalBadge.textContent = `目标 ${fmt(state.goal)} ml`;
      el.todayBadge.textContent = `今天 ${fmt(state.total)} ml`;
      el.statusBadge.textContent = pct >= 100 ? '已达成' : '未达成';
      el.statusBadge.className = 'badge ' + (pct >= 100 ? 'done' : '');

      // 顶部动态徽章
      el.badges.innerHTML = '';
      const b1 = document.createElement('span'); b1.className = 'badge'; b1.textContent = new Date().toLocaleDateString('zh-CN', { year:'numeric', month:'2-digit', day:'2-digit'});
      const b2 = document.createElement('span'); b2.className = 'badge'; b2.textContent = pct >= 100 ? '目标完成' : `剩余 ${fmt(Math.max(0, state.goal - state.total))} ml`;
      el.badges.append(b1, b2);
    }

    async function onToggleCup(e) {
      const idx = Number(e.currentTarget.getAttribute('data-idx'));
      const cup = state.smalls[idx];
      cup.filled = !cup.filled;
      state.total = state.smalls.filter(c => c.filled).reduce((s, c) => s + c.vol, 0);

      await idb.put({
        date: state.date,
        goal: state.goal,
        total: state.total,
        entries: state.smalls.map(c => ({ vol: c.vol, filled: c.filled }))
      });

      // ✅ 重绘全部 UI，而不是仅当前按钮
      renderSmallCups();
      updateProgress();
      renderCalendar(currentMonth);
    }

    /********************
     * 加载与同步当日数据
     ********************/
    async function loadToday() {
      const rec = await idb.get(state.date);
      if (rec) {
        state.goal = rec.goal ?? DAILY_GOAL_ML;
        state.total = rec.total ?? 0;
        // 与配置 SMALL_CUPS 对齐：以配置为基准展示，但如果历史中杯子数量不同，尽量映射
        const fromDb = rec.entries || [];
        state.smalls = SMALL_CUPS.map((vol, i) => ({ vol, filled: Boolean(fromDb[i]?.filled) }));
      } else {
        // 初始化
        await idb.put({
          date: state.date,
          goal: state.goal,
          total: 0,
          entries: state.smalls
        });
      }
      renderSmallCups();
      updateProgress();
    }

    /********************
     * 日历
     ********************/
    let currentMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

    function monthKey(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

    async function renderCalendar(baseDate) {
      const y = baseDate.getFullYear();
      const m = baseDate.getMonth();
      const first = new Date(y, m, 1);
      const last = new Date(y, m + 1, 0);

      el.calTitle.textContent = `${y}年${String(m+1).padStart(2,'0')}月`;
      el.calGrid.innerHTML = '';

      // 计算需要的前置空白（以周一为一周开始）
      const weekday = (first.getDay() + 6) % 7; // 0=Mon
      for (let i=0; i<weekday; i++) {
        const pad = document.createElement('div');
        pad.className = 'day';
        pad.style.visibility = 'hidden';
        el.calGrid.appendChild(pad);
      }

      const startKey = ymd(first);
      const endKey = ymd(last);
      const rows = await idb.range(startKey, endKey);
      const map = Object.fromEntries(rows.map(r => [r.date, r]));

      for (let d=1; d<=last.getDate(); d++) {
        const cur = new Date(y, m, d);
        const key = ymd(cur);
        const rec = map[key] || null;
        const total = rec?.total || 0;
        const goal = rec?.goal || DAILY_GOAL_ML;
        const pct = Math.min(100, Math.round((total/goal)*100) || 0);

        const cell = document.createElement('div');
        cell.className = 'day' + (key === state.date ? ' today' : '');
        cell.innerHTML = `
          <div class="date">${d}</div>
          <div class="amt">${fmt(total)} ml</div>
          <div class="pctBar" style="height:${pct}%"></div>
        `;
        el.calGrid.appendChild(cell);
      }
    }

    el.prevMonth.addEventListener('click', () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1);
      renderCalendar(currentMonth);
    });
    el.nextMonth.addEventListener('click', () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1);
      renderCalendar(currentMonth);
    });
    el.thisMonth.addEventListener('click', () => {
      currentMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      renderCalendar(currentMonth);
    });

    /********************
     * 启动
     ********************/
    (async function start(){
      await loadToday();
      await renderCalendar(currentMonth);
    })();
  </script>
</body>
</html>
